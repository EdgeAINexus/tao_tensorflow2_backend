FROM nvcr.io/nvstaging/tao/tao_tf2_base_image@sha256:1117b9f676cfa6d0a0be0ab573a44e2891b9acaa12c3768c40ca29a628d1a70d

# Installing the TAO Toolkit source code packages.
WORKDIR /opt/nvidia
COPY dist/*.whl /opt/nvidia/wheels/
RUN python -m pip install pip --upgrade \
    && cd wheels && ls ./*.whl|xargs -I'{}' python -m pip install '{}' \
    && rm *.whl

RUN rm -rf /opt/nvidia/entrypoint.d/*.txt
COPY release/docker/entrypoint.d/* /opt/nvidia/entrypoint.d/

# Changes required from security scan updates.
RUN apt-get update && apt-get install --only-upgrade libksba8 openssl libssl-dev linux-libc-dev -y

# Update pip package
RUN python -m pip install --upgrade joblib jupyter-core mpmath tornado werkzeug setuptools grpcio
# Removing graphviz since pip show shows no dependencies or requirements for it.
# Output of `pip show graphviz`
# Home-page: https://github.com/xflr6/graphviz
# Location: /usr/local/lib/python3.8/dist-packages
# Requires:
# Required-by:
# Updating container python packages
RUN python -m pip uninstall graphviz -y

# Resolving container scan vulnerabilities
ENV NVM_DIR=/usr/local/nvm
RUN source "$NVM_DIR/nvm.sh" \
    && nvm install 20.9.0 --reinstall-packages-from=16.20.2 node \
    && nvm uninstall 16.20.2

ENV NVIDIA_PRODUCT_NAME "TAO Toolkit"
ENV TAO_TOOLKIT_VERSION="4.0.0"
ENV NVIDIA_TAO_TOOLKIT_VERSION="${TAO_TOOLKIT_VERSION}-TF2"
ENV TAO_TELEMETRY_SERVER="https://sqa-telemetry.metropolis.nvidia.com:443/api/v1/telemetry"

# ================================================================================================
# Code Coverage
WORKDIR /workspace/tao-experiments
RUN python -m pip install coverage

# enable coverage hook on python startup
ARG hook_file=/usr/local/lib/python3.10/dist-packages/coverage.pth
RUN echo "import coverage; coverage.process_startup()" > ${hook_file}

# Enable code coverage run
RUN mkdir -p /workspace/code_coverage
COPY coveragerc /workspace/code_coverage/
ENV COVERAGE_PROCESS_START="/workspace/code_coverage/coveragerc"
# ================================================================================================

CMD [ "/bin/bash" ]
